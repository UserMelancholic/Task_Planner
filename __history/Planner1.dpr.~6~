// Главный модуль программы Организатор.
// Чтобы его увидеть, выберите в меню
// Project команду View Source.

program Planner1;

uses
  Forms,
  Unit1 in 'Unit1.pas', {Form1}
  SysUtils,Dialogs,
  DateUtils,  // для доступа к функции IncDay()
  DBTables;   // для доступа к таблице з данними



{$R *.res}
var
  Present: TDateTime;       // сегодня
  NextDay: TDateTime;       // следующий день
  Year, Month, Day : Word;  // год, месяц, день

  Query: TQuery; // запрос, обеспечивающий
                 // создание таблицы БД

begin
  Application.Initialize;
  Application.Title := 'Планировщик дел';
  Application.CreateForm(TForm1, Form1);

 { Псевдоним для доступа к базе данных создается во
   время запуска программы и существует только во
   время работы программы.
   База данных находится в том же каталоге, что
   и выполняемый файл программы. Имя каталога,
   в котором находится выполняемый файл можно получить
   обратившись к функции ParamStr(0). }

(*
  Session.ConfigMode := cmSession;
  Session.AddStandardAlias('tasks',   // псевдоним БД
                      ExtractFilePath(ParamStr(0)), // каталог
                     'PARADOX');    //  тип БД
*)
 // создадим псевдоним
 with Session do
 begin
    ConfigMode := cmSession;
    AddStandardAlias('tasks',   // псевдоним БД
                      ExtractFilePath(ParamStr(0)), // каталог
                     'PARADOX');
 end;


 // определим текущую дату
  Present:= Now; // Now - функция, возвращает текущую дату и время
  DecodeDate(Present, Year, Month, Day);

  case {dof} DayOfWeek(Present) of
    6:   NextDay := IncDay(Present,3);   // пятница
    7:   NextDay := IncDay(Present,2);   // суббта
    else NextDay := IncDay(Present,1)
  end;

  // запрос к базе данных: есть ли дела, запланированные
  // на сегодня и ближайшие дни
  Form1.Query1.SQL[3] :=
         '(Data >= '''+ FormatDateTime('dd/mm/yyyy',Present)+''')' +  'and'+
         '(Data <= '''+ FormatDateTime('dd/mm/yyyy',NextDay)+''')';

  try
    Form1.Query1.Open;  // выполнить запрос

  except
    on E:EDBEngineError do
        // Ошибка при выполнении запроса может
        // быть вызвана тем, что файла базы данных нет.
        // Предложить пользователю создать
        // файл базы данных.
        begin
            MessageDlg('Файл таблицы базы данных не найден .'+#13+
            'Таблица будет создана.',mtWarning,[mbYes],0);

            Query := TQuery.Create(Form1);    // создаем запрос на создание таблицы
            with Query do
            begin
                // сформируем запрос, обеспечивающий
                // создание таблицы Tasks
                SQL.Add('CREATE TABLE Tasks ( ');
                SQL.Add('Data DATE, ');
                SQL.Add('What CHAR(80), ');
                SQL.Add('Where CHAR(30) ); ');
                ExecSQL;   // Выполнить запрос на создание таблици
            end;
            // таблица создана
            Form1.Query1.Open; // выполним запрос
        end;
  end;
  if Form1.Query1.RecordCount > 0  // есть дела, запланированные на ближайшие дни
    then
        Form1.DataSource1.DataSet := Form1.Query1
        // Свойству DataSet(набор данних)
        // невизуального компонента DataSourсe1(источник данних)
        // присваеваем результат запроса Query1
    else  // Запрос верул 0 строк
        begin
            Form1.DataSource1.DataSet := Form1.Table1;
              // Источнику данных присваеваем таблицу
            Form1.Table1.Open;
            ShowMessage('На сегодня и ближайшие дни' +
                        'ни каких дел не запланировано.');
        end;

  Application.Run;
end.
